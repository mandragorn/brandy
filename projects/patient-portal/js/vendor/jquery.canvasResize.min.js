(function(e){var t="canvasResize",a={newsize:function(e,t,a,r,i){if(a&&e>a||r&&t>r){var n=e/t;if((n>=1||r===0)&&a&&!i){e=a;t=a/n>>0}else if(i&&n<=a/r){e=a;t=a/n>>0}else{e=r*n>>0;t=r}}return{width:e,height:t}},dataURLtoBlob:function(e){var t=e.split(",")[0].split(":")[1].split(";")[0];var a=atob(e.split(",")[1]);var r=new ArrayBuffer(a.length);var i=new Uint8Array(r);for(var n=0;n<a.length;n++){i[n]=a.charCodeAt(n)}var o=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;if(o){o=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);o.append(r);return o.getBlob(t)}else{o=new Blob([r],{type:t});return o}},detectSubsampling:function(e){var t=e.width,a=e.height;if(t*a>1048576){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");i.drawImage(e,-t+1,0);return i.getImageData(0,0,1,1).data[3]===0}else{return false}},rotate:function(e,t){var a={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return a[e][t]?a[e][t]:e},transformCoordinate:function(e,t,a,r){switch(r){case 5:case 6:case 7:case 8:e.width=a;e.height=t;break;default:e.width=t;e.height=a}var i=e.getContext("2d");switch(r){case 1:break;case 2:i.translate(t,0);i.scale(-1,1);break;case 3:i.translate(t,a);i.rotate(Math.PI);break;case 4:i.translate(0,a);i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI);i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI);i.translate(0,-a);break;case 7:i.rotate(.5*Math.PI);i.translate(t,-a);i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI);i.translate(-t,0);break;default:break}},detectVerticalSquash:function(e,t,a){var r=document.createElement("canvas");r.width=1;r.height=a;var i=r.getContext("2d");i.drawImage(e,0,0);var n=i.getImageData(0,0,1,a).data;var o=0;var l=a;var s=a;while(s>o){var c=n[(s-1)*4+3];if(c===0){l=s}else{o=s}s=l+o>>1}var h=s/a;return h===0?1:h},callback:function(e){return e}},r={width:300,height:0,crop:false,quality:80,callback:a.callback};function i(a,i){this.file=a;this.options=e.extend({},r,i);this._defaults=r;this._name=t;this.init()}i.prototype={init:function(){var t=this;var r=this.file;var i=new FileReader;i.onloadend=function(r){var i=r.target.result;var n=new Image;n.onload=function(r){e(n).exifLoadFromDataURL(function(){var r=e(n).exif("Orientation")[0]||1;r=a.rotate(r,t.options.rotate);var i=r>=5&&r<=8?a.newsize(n.height,n.width,t.options.width,t.options.height,t.options.crop):a.newsize(n.width,n.height,t.options.width,t.options.height,t.options.crop);var o=n.width,l=n.height;var s=i.width,c=i.height;var h=document.createElement("canvas");var d=h.getContext("2d");d.save();a.transformCoordinate(h,s,c,r);if(a.detectSubsampling(n)){o/=2;l/=2}var v=1024;var w=document.createElement("canvas");w.width=w.height=v;var u=w.getContext("2d");var g=a.detectVerticalSquash(n,o,l);var f=0;while(f<l){var b=f+v>l?l-f:v;var p=0;while(p<o){var m=p+v>o?o-p:v;u.clearRect(0,0,v,v);u.drawImage(n,-p,-f);var B=Math.floor(p*s/o);var k=Math.ceil(m*s/o);var I=Math.floor(f*c/l/g);var x=Math.ceil(b*c/l/g);d.drawImage(w,0,0,m,b,B,I,k,x);p+=v}f+=v}d.restore();w=u=null;var M=document.createElement("canvas");M.width=s;M.height=c;newctx=M.getContext("2d");newctx.drawImage(h,0,0,s,c);var C=M.toDataURL("image/jpeg",t.options.quality*.01);t.options.callback(C,s,c)})};n.src=i};i.readAsDataURL(r)}};e[t]=function(e,t){if(typeof e==="string")return a[e](t);else new i(e,t)}})(jQuery);
